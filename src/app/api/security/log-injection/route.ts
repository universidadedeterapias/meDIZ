/**
 * üîí API Route para Processar Alertas de Inje√ß√£o
 * 
 * Esta rota √© chamada de forma ass√≠ncrona pelo middleware quando uma inje√ß√£o √© detectada.
 * Ela roda no Node.js runtime (n√£o Edge), permitindo uso do Prisma.
 */

import { NextRequest, NextResponse } from 'next/server'
import { processInjectionDetection } from '@/lib/security/injection-alert-service'
import type { InjectionDetectionResult } from '@/lib/security/injection-detector'

export const runtime = 'nodejs' // For√ßa Node.js runtime (n√£o Edge)

export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    
    const {
      detection,
      endpoint,
      method,
      ipAddress,
      userAgent,
      userId
    } = body
    
    // Validar dados obrigat√≥rios
    if (!detection || !endpoint || !method) {
      return NextResponse.json(
        { error: 'Dados inv√°lidos' },
        { status: 400 }
      )
    }
    
    // Criar requisi√ß√£o mock para processar
    const mockReq = new NextRequest('http://localhost:3000' + endpoint, {
      method,
      headers: {
        'x-forwarded-for': ipAddress || 'unknown',
        'user-agent': userAgent || 'unknown'
      }
    })
    
    // Processar alerta
    const result = await processInjectionDetection(
      detection as InjectionDetectionResult,
      mockReq,
      endpoint,
      userId
    )
    
    return NextResponse.json({
      success: true,
      attemptId: result.attemptId,
      alertSent: result.alertSent
    })
  } catch (error) {
    console.error('[LogInjection API] Erro:', error)
    const message = error instanceof Error ? error.message : 'Erro desconhecido'
    return NextResponse.json(
      { error: 'Erro ao processar alerta', message },
      { status: 500 }
    )
  }
}

