/**
 * 游댢 Helper para usar detec칞칚o de inje칞칚o em rotas API
 * 
 * Use este helper nas rotas API para analisar o body ap칩s j치 ter sido lido
 */

import { detectInjection } from './injection-detector'
import { processInjectionDetection } from './injection-alert-service'
import { NextRequest, NextResponse } from 'next/server'

/**
 * Analisa dados j치 parseados de uma rota API para detectar inje칞칫es
 * 
 * Use isso dentro das rotas API ap칩s ler o body:
 * 
 * @example
 * ```typescript
 * export async function POST(req: NextRequest) {
 *   const body = await req.json()
 *   
 *   // Analisar antes de processar
 *   const detection = await analyzeRouteData(req, '/api/user/form', body)
 *   if (detection) {
 *     return detection // Retorna resposta 403
 *   }
 *   
 *   // Continuar processamento normal...
 * }
 * ```
 */
export async function analyzeRouteData(
  req: NextRequest,
  endpoint: string,
  body: unknown,
  userId?: string
): Promise<NextResponse | null> {
  try {
    // Extrair query params
    const queryParams: Record<string, unknown> = {}
    req.nextUrl.searchParams.forEach((value, key) => {
      queryParams[key] = value
    })
    
    // Extrair headers
    const headers: Record<string, string> = {}
    req.headers.forEach((value, key) => {
      headers[key] = value
    })
    
    // Executar detec칞칚o
    const detections = detectInjection({
      query: Object.keys(queryParams).length > 0 ? queryParams : undefined,
      body,
      headers,
      path: endpoint
    })
    
    // Se n칚o houver detec칞칚o, retornar null (continua processamento)
    if (detections.length === 0) {
      return null
    }
    
    // Detec칞칚o encontrada
    const primaryDetection = detections[0]
    
    // Disparar alerta
    try {
      await processInjectionDetection(
        primaryDetection,
        req,
        endpoint,
        userId
      )
    } catch (error) {
      console.error('[InjectionRouteHelper] Erro ao processar alerta:', error)
    }
    
    // 游뛂 BLOQUEIO DESATIVADO: Apenas logar sem bloquear
    // Para reativar bloqueio, defina SECURITY_ENABLE_BLOCK=true no .env
    const ENABLE_BLOCK = process.env.SECURITY_ENABLE_BLOCK === 'true'
    
    if (ENABLE_BLOCK) {
      // Bloquear requisi칞칚o apenas se explicitamente habilitado
      return NextResponse.json(
        {
          error: 'Requisi칞칚o bloqueada por seguran칞a',
          message: 'Padr칚o malicioso detectado na requisi칞칚o',
          code: 'SECURITY_BLOCKED'
        },
        { status: 403 }
      )
    }
    
    // Por padr칚o, apenas logar mas n칚o bloquear
    console.warn(`[InjectionRouteHelper] 游댌 Detec칞칚o registrada (sem bloqueio):`, {
      type: primaryDetection.type,
      pattern: primaryDetection.pattern,
      endpoint,
      field: primaryDetection.details.field
    })
    
    return null
  } catch (error) {
    console.error('[InjectionRouteHelper] Erro:', error)
    return null // Fail open
  }
}

