// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

// üîç DEBUG: Log durante inicializa√ß√£o do Prisma
console.log('[DEBUG prisma.ts] Iniciando configura√ß√£o do Prisma Client...')
console.log('[DEBUG prisma.ts] DATABASE_URL:', process.env.DATABASE_URL ? '‚úÖ Configurado' : '‚ùå N√£o configurado')
console.log('[DEBUG prisma.ts] NODE_ENV:', process.env.NODE_ENV)

// evita m√∫ltiplas inst√¢ncias em dev
const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient({
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  errorFormat: 'pretty',
})

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

// Testar conex√£o na inicializa√ß√£o (n√£o bloquear, apenas logar)
// O Next.js carregar√° as vari√°veis antes de usar o Prisma
if (process.env.DATABASE_URL) {
  console.log('[DEBUG prisma.ts] Tentando conectar ao banco de dados...')
  prisma.$connect()
    .then(() => {
      console.log('[DEBUG prisma.ts] ‚úÖ Conex√£o com banco estabelecida com sucesso')
    })
    .catch((error) => {
      console.error('[DEBUG prisma.ts] ‚ùå Erro ao conectar com o banco de dados:')
      console.error('[DEBUG prisma.ts] Tipo do erro:', error?.constructor?.name)
      console.error('[DEBUG prisma.ts] Mensagem:', error?.message)
      console.error('[DEBUG prisma.ts] Stack:', error?.stack)
      console.error('[DEBUG prisma.ts] DATABASE_URL usado:', process.env.DATABASE_URL ? `${process.env.DATABASE_URL.substring(0, 20)}...` : 'N√ÉO DEFINIDO')
      // N√£o fazer exit imediato, deixar o Next.js gerenciar
      console.error('[DEBUG prisma.ts] ‚ö†Ô∏è  A conex√£o ser√° tentada novamente quando necess√°rio')
    })
} else {
  console.warn('[DEBUG prisma.ts] ‚ö†Ô∏è  DATABASE_URL n√£o dispon√≠vel ainda - ser√° carregado pelo Next.js')
}
