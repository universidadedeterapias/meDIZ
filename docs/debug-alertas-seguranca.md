# üîç Debug: Alertas de Seguran√ßa - Guia de Diagn√≥stico

## ‚úÖ Corre√ß√µes Aplicadas

### Problema 1: Formata√ß√£o Dupla de Mensagem
**Problema:** A fun√ß√£o `sendSecurityAlert` estava recebendo uma mensagem j√° formatada, causando formata√ß√£o dupla.

**Solu√ß√£o:** Alterado para usar `sendWhatsAppText` diretamente, j√° que a mensagem j√° est√° formatada.

**Arquivo corrigido:** `src/lib/security/injection-alert-service.ts`

### Problema 2: Importa√ß√µes
**Status:** ‚úÖ Todas as importa√ß√µes est√£o corretas

---

## üß™ Como Testar

### Teste 1: Teste Manual de Detec√ß√£o

```bash
# Executar script de teste
tsx scripts/test-injection-alerts.ts
```

Este script testa:
- ‚úÖ Detec√ß√£o de SQL Injection
- ‚úÖ Detec√ß√£o de Command Injection
- ‚úÖ Valores seguros (sem falsos positivos)
- ‚úÖ Processamento de alertas

### Teste 2: Teste Real via API

```bash
# Teste SQL Injection no endpoint /api/user/form
curl -X POST http://localhost:3000/api/user/form \
  -H "Content-Type: application/json" \
  -H "Cookie: authjs.session-token=SEU_TOKEN_AQUI" \
  -d '{"fullName": "'; DROP TABLE users; --", "age": 30}'

# Esperado: 403 Forbidden + Alerta enviado
```

### Teste 3: Verificar Logs do Servidor

Procure por logs como:
```
[SecurityMiddleware] üö® INJE√á√ÉO DETECTADA
[InjectionAlert] Tentativa de SQL_INJECTION detectada e processada
[InjectionAlert] Alerta enviado para admin@mediz.com
```

---

## üîç Checklist de Verifica√ß√£o

### 1. Banco de Dados
- [ ] Tabela `injection_attempts` existe
- [ ] Migration executada: `npx prisma migrate dev`
- [ ] Prisma Client gerado: `npx prisma generate`

### 2. Vari√°veis de Ambiente (WhatsApp)
- [ ] `ZAPI_BASE_URL` configurado
- [ ] `ZAPI_INSTANCE_ID` configurado
- [ ] `ZAPI_TOKEN` configurado
- [ ] `ZAPI_CLIENT_TOKEN` configurado (opcional)

**Como verificar:**
```bash
node -e "console.log('ZAPI_BASE_URL:', process.env.ZAPI_BASE_URL)"
```

### 3. Admins com WhatsApp
- [ ] Existe pelo menos 1 admin com email `@mediz.com`
- [ ] Admin tem campo `whatsapp` preenchido no banco

**Query para verificar:**
```sql
SELECT email, whatsapp FROM users WHERE email LIKE '%@mediz.com' AND whatsapp IS NOT NULL;
```

### 4. Sistema de Detec√ß√£o
- [ ] Middleware est√° ativo (verificar `src/middleware.ts`)
- [ ] Helper est√° sendo usado nas rotas (verificar `/api/user/form`)
- [ ] Biblioteca de detec√ß√£o est√° funcionando

### 5. Logs e Monitoramento
- [ ] Logs aparecem no console quando detec√ß√£o ocorre
- [ ] Registros s√£o salvos no banco (`injection_attempts`)
- [ ] Alertas aparecem no painel admin (`/admin/injection-attempts`)

---

## üêõ Problemas Comuns e Solu√ß√µes

### Problema: Alertas n√£o est√£o sendo enviados

**Poss√≠veis causas:**

1. **WhatsApp n√£o configurado**
   - Verifique vari√°veis de ambiente
   - No modo desenvolvimento, alertas s√£o simulados (ver console)

2. **Nenhum admin com WhatsApp**
   - Verifique no banco de dados
   - Adicione WhatsApp a um admin

3. **Erro silencioso**
   - Verifique logs do servidor
   - Procure por `[InjectionAlert] Erro`

**Como diagnosticar:**
```bash
# Ver logs em tempo real
npm run dev | grep -i "injectionalert\|securitymiddleware"
```

### Problema: Detec√ß√£o n√£o est√° funcionando

**Poss√≠veis causas:**

1. **Middleware n√£o est√° executando**
   - Verifique `src/middleware.ts` linha 11-16
   - Verifique se rota come√ßa com `/api/`

2. **Padr√µes muito restritivos**
   - Verifique `src/lib/security/injection-detector.ts`
   - Teste com payload conhecido

3. **Whitelist muito permissiva**
   - Verifique fun√ß√£o `isSafeValue`

**Como diagnosticar:**
```typescript
// Adicionar log tempor√°rio no middleware
console.log('[DEBUG] Analisando:', { endpoint, hasQuery: !!queryParams })
```

### Problema: Falsos Positivos

**Solu√ß√£o:**
- Ajuste padr√µes em `injection-detector.ts`
- Adicione padr√µes √† whitelist em `SAFE_PATTERNS`

---

## üìä Verifica√ß√£o de Fluxo Completo

### Fluxo Esperado:

```
1. Requisi√ß√£o maliciosa chega
   ‚Üì
2. Middleware intercepta (/api/*)
   ‚Üì
3. Detec√ß√£o executa (injection-detector.ts)
   ‚Üì
4. Se detectado:
   a. Registra no banco (injection_attempts)
   b. Formata mensagem de alerta
   c. Busca admins com WhatsApp
   d. Envia alerta para cada admin
   e. Atualiza registro (alertSent = true)
   f. Registra no audit log
   ‚Üì
5. Bloqueia requisi√ß√£o (403)
```

### Verifica√ß√µes em Cada Etapa:

**Etapa 1-2:** Verificar logs do middleware
```bash
[SecurityMiddleware] Analisando requisi√ß√£o...
```

**Etapa 3:** Verificar detec√ß√£o
```bash
[SecurityMiddleware] üö® INJE√á√ÉO DETECTADA: { type: 'SQL_INJECTION' }
```

**Etapa 4a:** Verificar banco
```sql
SELECT * FROM injection_attempts ORDER BY created_at DESC LIMIT 1;
```

**Etapa 4b-d:** Verificar envio
```bash
[InjectionAlert] Alerta enviado para admin@mediz.com
```

**Etapa 4e:** Verificar atualiza√ß√£o
```sql
SELECT alert_sent FROM injection_attempts WHERE id = '...';
-- Deve ser true
```

**Etapa 5:** Verificar resposta HTTP
```bash
Status: 403 Forbidden
Body: { "error": "Requisi√ß√£o bloqueada por seguran√ßa" }
```

---

## üõ†Ô∏è Ferramentas de Debug

### Script de Teste Autom√°tico
```bash
tsx scripts/test-injection-alerts.ts
```

### Verificar Status do Sistema
```sql
-- Ver √∫ltimas tentativas
SELECT * FROM injection_attempts ORDER BY created_at DESC LIMIT 10;

-- Ver estat√≠sticas
SELECT 
  type,
  severity,
  COUNT(*) as total,
  SUM(CASE WHEN alert_sent THEN 1 ELSE 0 END) as alerts_sent
FROM injection_attempts
GROUP BY type, severity;
```

### Logs do Servidor
```bash
# Filtrar apenas logs de seguran√ßa
npm run dev 2>&1 | grep -E "\[SecurityMiddleware\]|\[InjectionAlert\]"
```

---

## ‚úÖ Checklist Final

Antes de considerar que est√° funcionando:

- [ ] Script de teste passa em todos os casos
- [ ] Requisi√ß√£o maliciosa retorna 403
- [ ] Registro aparece no banco (`injection_attempts`)
- [ ] Alerta √© enviado (ver logs ou WhatsApp)
- [ ] Registro mostra `alertSent = true`
- [ ] Audit log cont√©m entrada
- [ ] Painel admin mostra tentativa (`/admin/injection-attempts`)

---

## üìû Suporte

Se ap√≥s todas as verifica√ß√µes ainda n√£o funcionar:

1. Verifique logs completos do servidor
2. Verifique se todas as depend√™ncias est√£o instaladas
3. Execute `npx prisma generate` novamente
4. Verifique se o banco est√° acess√≠vel
5. Teste envio manual de WhatsApp via `/admin/security-alerts`

---

**√öltima atualiza√ß√£o:** Janeiro 2025  
**Vers√£o:** 1.0

