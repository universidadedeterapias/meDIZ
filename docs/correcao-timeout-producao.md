# üîß Corre√ß√£o de Erros 504 (Timeout) em Produ√ß√£o

## üìã Problema Identificado

**Erro:** `FUNCTION_INVOCATION_TIMEOUT` - Erro 504 em produ√ß√£o  
**Causa:** Conflito entre timeout do c√≥digo e timeout do Vercel

### An√°lise do Problema

1. **Timeout do Vercel:** Configurado para 30 segundos (`vercel.json`)
2. **Timeout do c√≥digo:** `waitForRunCompletion` podia demorar at√© 60 segundos
3. **Consequ√™ncia:** Vercel cancelava a fun√ß√£o antes do c√≥digo terminar ‚Üí Erro 504

---

## ‚úÖ Corre√ß√µes Implementadas

### 1. **Aumento do Timeout no Vercel**

**Arquivo:** `vercel.json`

**Mudan√ßa:**
- Endpoint `/api/openai` agora tem timeout de **300 segundos (5 minutos)**
- Outras APIs: **60 segundos**

```json
{
  "functions": {
    "src/app/api/openai/route.ts": {
      "maxDuration": 300  // 5 minutos para OpenAI
    },
    "src/app/api/**/*.ts": {
      "maxDuration": 60  // 1 minuto para outras APIs
    }
  }
}
```

**Benef√≠cio:** D√° tempo suficiente para o Assistants API processar consultas complexas.

---

### 2. **Configura√ß√£o de Timeout no Next.js 15**

**Arquivo:** `src/app/api/openai/route.ts`

**Adicionado:**
```typescript
export const maxDuration = 300 // 5 minutos
export const runtime = 'nodejs' // Garante uso do runtime Node.js
```

**Benef√≠cio:** Next.js 15 reconhece e respeita o timeout configurado.

---

### 3. **Aumento do Timeout de Polling**

**Arquivo:** `src/lib/assistant.ts`

**Mudan√ßa:**
- **Antes:** 60 tentativas (60 segundos m√°ximo)
- **Depois:** 240 tentativas (4 minutos m√°ximo)

**Polling adaptativo:**
- Primeiros 10 tentativas: 500ms (5 segundos)
- Pr√≥ximas 50 tentativas: 1000ms (50 segundos)
- Restante: 2000ms (3 minutos 40 segundos)

**Benef√≠cio:** D√° mais tempo para a OpenAI processar consultas complexas, com polling eficiente.

---

### 4. **Melhorias no Tratamento de Erros**

**Arquivo:** `src/app/api/openai/route.ts`

**Melhorias:**
- ‚úÖ Detec√ß√£o espec√≠fica de timeouts
- ‚úÖ Logs detalhados de performance
- ‚úÖ Mensagens de erro mais informativas
- ‚úÖ Retorno de status 504 espec√≠fico para timeout

**Exemplo de log:**
```
[API OpenAI] üöÄ Iniciando processamento para usu√°rio abc123
[API OpenAI] ‚úÖ Thread criada em 234ms: thread_abc
[API OpenAI] üîÑ Run iniciado em 456ms: run_xyz
[API OpenAI] ‚úÖ Run completado em 45234ms
[API OpenAI] üì® Mensagens obtidas em 123ms
[API OpenAI] ‚úÖ Processamento completo em 46023ms
```

---

### 5. **Melhorias no Frontend**

**Arquivo:** `src/app/chat/page.tsx`

**Melhorias:**
- ‚úÖ Detec√ß√£o espec√≠fica de erro 504
- ‚úÖ Mensagens de erro amig√°veis e acion√°veis
- ‚úÖ Tratamento diferenciado para diferentes tipos de erro
- ‚úÖ Redirecionamento autom√°tico em caso de erro de autentica√ß√£o

**Mensagens de erro:**
- **Timeout (504):** "A consulta est√° demorando... tente reformular a pergunta"
- **Network:** "Erro de conex√£o... verifique sua internet"
- **Auth (401):** "Voc√™ precisa fazer login novamente" + redirecionamento

---

## üìä Compara√ß√£o: Antes vs. Depois

### Antes
- ‚ùå Timeout Vercel: 30s
- ‚ùå Timeout c√≥digo: 60s
- ‚ùå **Conflito:** Fun√ß√£o cancelada antes de terminar
- ‚ùå Erro gen√©rico: "FUNCTION_INVOCATION_TIMEOUT"
- ‚ùå Sem logs de performance

### Depois
- ‚úÖ Timeout Vercel: 300s (5 min)
- ‚úÖ Timeout c√≥digo: 240s (4 min)
- ‚úÖ **Compat√≠vel:** Margem de 60s antes do timeout
- ‚úÖ Erro espec√≠fico: Mensagem clara sobre timeout
- ‚úÖ Logs detalhados para debugging

---

## üéØ Benef√≠cios das Corre√ß√µes

### Para Usu√°rios
- ‚úÖ Consultas complexas n√£o s√£o mais interrompidas
- ‚úÖ Mensagens de erro mais claras e acion√°veis
- ‚úÖ Melhor experi√™ncia quando h√° problemas

### Para Desenvolvimento
- ‚úÖ Logs detalhados facilitam debugging
- ‚úÖ Identifica√ß√£o r√°pida de gargalos
- ‚úÖ M√©tricas de performance (tempo de cada etapa)

### Para Produ√ß√£o
- ‚úÖ Menos erros 504
- ‚úÖ Maior taxa de sucesso nas consultas
- ‚úÖ Monitoramento melhor com logs estruturados

---

## üìù Limita√ß√µes e Considera√ß√µes

### Plano do Vercel

**‚ö†Ô∏è IMPORTANTE:** Timeout de 300 segundos (5 minutos) requer plano **Pro** do Vercel.

**Planos Vercel:**
- **Hobby (Free):** M√°ximo 10 segundos
- **Pro:** M√°ximo 300 segundos (5 minutos) ‚úÖ
- **Enterprise:** M√°ximo 900 segundos (15 minutos)

**Se estiver no plano Hobby:**
- Atualize para Pro, ou
- Reduza o timeout para 10 segundos e otimize o c√≥digo (n√£o recomendado)

### Monitoramento

Recomenda√ß√µes:
1. **Monitorar logs** para identificar consultas que demoram muito
2. **Alertar** se mais de 50% das consultas demorarem > 2 minutos
3. **Otimizar** o Assistants API se necess√°rio (modelo, instru√ß√µes, etc.)

---

## üîç Como Verificar se Est√° Funcionando

### 1. Verificar Timeout no Vercel
```bash
# O arquivo vercel.json deve ter maxDuration: 300 para /api/openai
cat vercel.json
```

### 2. Testar Localmente
```bash
# Iniciar servidor
npm run dev

# Fazer uma consulta complexa
# Verificar logs no terminal
```

### 3. Verificar Logs em Produ√ß√£o
- Acesse Vercel Dashboard ‚Üí Deployments ‚Üí Functions
- Procure por logs com prefixo `[API OpenAI]` ou `[Assistant]`
- Verifique tempos de processamento

---

## üö® Troubleshooting

### Erro 504 ainda ocorre

**Poss√≠veis causas:**
1. **Plano Hobby:** Upgrade necess√°rio para Pro
2. **Timeout do c√≥digo > 5 minutos:** Otimizar `waitForRunCompletion`
3. **Problema na OpenAI:** Verificar status da API

**Solu√ß√µes:**
```typescript
// Se timeout ainda ocorrer, reduzir maxAttempts
const maxAttempts = 120 // 2 minutos (margem de seguran√ßa)
```

### Consultas muito lentas

**Otimiza√ß√µes poss√≠veis:**
1. **Simplificar instru√ß√µes do Assistants API**
2. **Usar modelo mais r√°pido** (ex: gpt-4-turbo ao inv√©s de gpt-4)
3. **Implementar cache** para consultas similares
4. **Streaming de resposta** (processar enquanto gera)

---

## üìö Refer√™ncias

- [Vercel Function Duration Limits](https://vercel.com/docs/functions/runtimes/max-duration)
- [OpenAI Assistants API](https://platform.openai.com/docs/assistants)
- [Next.js 15 Route Segment Config](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#maxduration)

---

**√öltima atualiza√ß√£o:** Janeiro 2025  
**Status:** ‚úÖ Implementado e testado

