# üìö Documenta√ß√£o da API - meDIZ

## üéØ Vis√£o Geral

Esta documenta√ß√£o descreve todas as rotas da API REST da plataforma meDIZ, uma aplica√ß√£o Next.js 15 que oferece consultas de IA para sa√∫de e bem-estar atrav√©s de chat conversacional.

**Base URL:** `https://mediz.app/api` (produ√ß√£o) ou `http://localhost:3000/api` (desenvolvimento)

**Formato de Resposta:** Todas as respostas s√£o em JSON, exceto downloads de arquivos (CSV, PDF).

---

## üîê Autentica√ß√£o

A plataforma usa **NextAuth v5** com m√∫ltiplos provedores:

- **JWT Strategy** - Sess√µes com dura√ß√£o de 365 dias
- **Credentials Provider** - Login com email e senha (hash bcrypt)
- **Google OAuth** - Login social via Google
- **PrismaAdapter** - Armazena sess√µes e contas no banco de dados

### Como usar

```typescript
// Server Component
import { auth } from '@/auth'
const session = await auth()

// Client Component
import { signIn, signOut } from 'next-auth/react'
await signIn('credentials', { email, password })
```

### Headers de Autentica√ß√£o

As requisi√ß√µes autenticadas dependem de cookies HTTP-only gerenciados pelo NextAuth. N√£o √© necess√°rio enviar headers manuais - o navegador envia os cookies automaticamente.

---

## üõ†Ô∏è Stack Tecnol√≥gico

### Frontend
- **Next.js 15.2.4** - Framework React com App Router
- **React 19.0.0** - Biblioteca UI
- **TypeScript 5.8.2** - Tipagem est√°tica
- **Tailwind CSS 3.4.1** - Framework CSS utility-first
- **Framer Motion 12.23.6** - Anima√ß√µes
- **Radix UI** - Componentes acess√≠veis (Dialog, Dropdown, etc)
- **React Hook Form 7.57.0** - Gerenciamento de formul√°rios
- **Zod 3.25.64** - Valida√ß√£o de schemas
- **Lucide React 0.476.0** - √çcones

### Backend & Database
- **Prisma 6.5.0** - ORM para PostgreSQL
- **PostgreSQL** - Banco de dados relacional
- **NextAuth 5.0.0-beta.25** - Autentica√ß√£o
- **bcryptjs 3.0.2** - Hash de senhas (10 rounds)

### Integra√ß√µes Externas
- **OpenAI API** - Assistente IA conversacional (Assistants API v2)
- **Stripe 18.3.0** - Processamento de pagamentos
- **Hotmart** - Webhooks de afiliados e assinaturas
- **Cloudinary 2.7.0** - Upload e otimiza√ß√£o de imagens
- **html2pdf.js 0.12.1** - Gera√ß√£o de PDFs

### Utilities
- **date-fns 4.1.0** - Manipula√ß√£o de datas
- **class-variance-authority 0.7.1** - Variantes de componentes
- **tailwind-merge 3.0.2** - Merge de classes Tailwind
- **react-markdown 10.1.0** - Renderiza√ß√£o de Markdown

---

## üìã Estrutura da API

### Organiza√ß√£o

As rotas seguem a conven√ß√£o do Next.js App Router:
- Cada arquivo `route.ts` exporta fun√ß√µes nomeadas (`GET`, `POST`, `PUT`, `PATCH`, `DELETE`)
- Rotas din√¢micas usam `[id]` ou `[...nextauth]` (catch-all)
- Autentica√ß√£o √© verificada em cada endpoint quando necess√°rio

---

## üîë Endpoints de Autentica√ß√£o

### `POST /api/auth/[...nextauth]`

Rota catch-all do NextAuth que gerencia todas as opera√ß√µes de autentica√ß√£o.

**Endpoints gerados:**
- `GET /api/auth/signin` - P√°gina de login
- `POST /api/auth/signin/:provider` - Iniciar login com provedor
- `POST /api/auth/signout` - Fazer logout
- `GET /api/auth/session` - Obter sess√£o atual
- `GET /api/auth/csrf` - Obter CSRF token
- `GET /api/auth/providers` - Listar provedores dispon√≠veis
- `GET /api/auth/callback/:provider` - Callback OAuth

**Provedores dispon√≠veis:**
- `credentials` - Email e senha
- `google` - Google OAuth

---

### `POST /api/auth/signup`

Criar novo usu√°rio com email e senha.

**Request Body:**
```json
{
  "email": "usuario@example.com",
  "password": "senhaSegura123",
  "name": "Nome do Usu√°rio"
}
```

**Response (201):**
```json
{
  "success": true,
  "userId": "uuid-do-usuario"
}
```

**Erros:**
- `400` - Email j√° existe ou dados inv√°lidos
- `500` - Erro interno do servidor

---

### `POST /api/auth/update-whatsapp`

Atualizar n√∫mero de WhatsApp do usu√°rio autenticado.

**Request Body:**
```json
{
  "whatsapp": "+5511999999999"
}
```

**Response (200):**
```json
{
  "success": true,
  "whatsapp": "+5511999999999"
}
```

**Autentica√ß√£o:** Obrigat√≥ria

---

## üë§ Endpoints de Usu√°rio

### `GET /api/user`

Obter dados completos do usu√°rio autenticado.

**Response (200):**
```json
{
  "id": "uuid",
  "name": "Nome",
  "email": "usuario@example.com",
  "fullName": "Nome Completo",
  "whatsapp": "+5511999999999",
  "age": 30,
  "gender": "MALE",
  "profession": "Terapeuta",
  "appUsage": "PROFESSIONAL",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "subscriptions": [...]
}
```

**Autentica√ß√£o:** Obrigat√≥ria

---

### `GET /api/user/sidebar`

Endpoint otimizado para carregar apenas dados necess√°rios da sidebar (performance).

**Response (200):**
```json
{
  "id": "uuid",
  "name": "Nome",
  "email": "usuario@example.com",
  "image": "url-da-imagem"
}
```

**Autentica√ß√£o:** Obrigat√≥ria

**Performance:** Busca apenas campos essenciais, reduzindo tempo de carregamento.

---

### `PUT /api/user/form`

Atualizar dados do formul√°rio do usu√°rio.

**Request Body:**
```json
{
  "fullName": "Nome Completo",
  "age": 30,
  "gender": "MALE",
  "profession": "Profiss√£o",
  "appUsage": "PERSONAL",
  "description": "Descri√ß√£o",
  "whatsapp": "+5511999999999",
  "educationOrSpecialty": "Especialidade",
  "yearsOfExperience": "5",
  "clientsPerWeek": "10",
  "averageSessionPrice": "100"
}
```

**Response (200):**
```json
{
  "success": true,
  "user": { ... }
}
```

**Autentica√ß√£o:** Obrigat√≥ria

---

### `POST /api/user/avatar`

Upload de avatar do usu√°rio (Cloudinary).

**Request:** `multipart/form-data`
- `file`: Arquivo de imagem (JPEG, PNG, WebP)
- M√°ximo: 5MB

**Response (200):**
```json
{
  "success": true,
  "imageUrl": "https://cloudinary.com/..."
}
```

**Autentica√ß√£o:** Obrigat√≥ria

---

## üí¨ Endpoints de Chat

### `POST /api/openai`

Enviar mensagem ao assistente IA e receber resposta.

**Request Body:**
```json
{
  "message": "Dores de cabe√ßa frequentes"
}
```

**Response (200):**
```json
{
  "responses": {
    "assistant": [
      "Resposta do assistente em markdown..."
    ]
  },
  "threadId": "thread_abc123",
  "userPeriod": "first_8_days",
  "fullVisualization": false,
  "shouldShowPopup": false
}
```

**Erros:**
- `401` - N√£o autenticado
- `403` - Limite de buscas atingido (plano gratuito)
- `500` - Erro na API OpenAI

**Limites:**
- **Plano Gratuito:** 
  - Primeiros 8 dias: 3 buscas/dia
  - Dias 9-30: 1 busca/dia
- **Plano Premium:** Ilimitado

**Autentica√ß√£o:** Obrigat√≥ria

---

### `GET /api/chat/sessions`

Listar sess√µes de chat do usu√°rio.

**Response (200):**
```json
[
  {
    "id": "uuid",
    "threadId": "thread_abc123",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "favorite": false
  }
]
```

**Autentica√ß√£o:** Obrigat√≥ria

---

## üìÅ Endpoints de Pastas e Sintomas

### `GET /api/folders`

Listar todas as pastas de sintomas do usu√°rio.

**Response (200):**
```json
[
  {
    "id": "uuid",
    "name": "Nome da Pasta",
    "color": "#4f46e5",
    "notes": "Notas da pasta",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "symptoms": [
      {
        "id": "uuid",
        "symptom": "Dor de cabe√ßa",
        "threadId": "thread_abc123"
      }
    ]
  }
]
```

**Autentica√ß√£o:** Obrigat√≥ria

**Premium:** Funcionalidade dispon√≠vel apenas para usu√°rios premium

---

### `POST /api/folders`

Criar nova pasta de sintomas.

**Request Body:**
```json
{
  "name": "Nome da Pasta",
  "color": "#4f46e5",
  "notes": "Notas opcionais"
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "name": "Nome da Pasta",
  "color": "#4f46e5",
  "notes": "Notas opcionais",
  "userId": "uuid",
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

**Autentica√ß√£o:** Obrigat√≥ria

**Premium:** Funcionalidade dispon√≠vel apenas para usu√°rios premium

---

### `PATCH /api/folders/[id]`

Atualizar pasta de sintomas.

**Request Body:**
```json
{
  "name": "Novo Nome",
  "color": "#10b981",
  "notes": "Novas notas"
}
```

**Response (200):**
```json
{
  "id": "uuid",
  "name": "Novo Nome",
  ...
}
```

**Autentica√ß√£o:** Obrigat√≥ria

**Premium:** Funcionalidade dispon√≠vel apenas para usu√°rios premium

---

### `DELETE /api/folders/[id]`

Excluir pasta de sintomas.

**Response (200):**
```json
{
  "success": true
}
```

**Autentica√ß√£o:** Obrigat√≥ria

**Premium:** Funcionalidade dispon√≠vel apenas para usu√°rios premium

---

### `POST /api/symptoms`

Salvar sintoma em uma pasta.

**Request Body:**
```json
{
  "folderId": "uuid-da-pasta",
  "symptom": "Dor de cabe√ßa frequente",
  "threadId": "thread_abc123"
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "folderId": "uuid-da-pasta",
  "symptom": "Dor de cabe√ßa frequente",
  "threadId": "thread_abc123",
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

**Autentica√ß√£o:** Obrigat√≥ria

**Premium:** Funcionalidade dispon√≠vel apenas para usu√°rios premium

---

### `DELETE /api/symptoms/[id]`

Excluir sintoma salvo.

**Response (200):**
```json
{
  "success": true
}
```

**Autentica√ß√£o:** Obrigat√≥ria

**Premium:** Funcionalidade dispon√≠vel apenas para usu√°rios premium

---

### `GET /api/symptoms/popular`

Obter lista de sintomas mais pesquisados (cache).

**Response (200):**
```json
{
  "symptoms": [
    {
      "symptom": "Dor de cabe√ßa",
      "count": 150,
      "lastUpdated": "2024-01-01T00:00:00.000Z"
    }
  ],
  "lastUpdated": "2024-01-01T00:00:00.000Z"
}
```

**Autentica√ß√£o:** Opcional

---

### `POST /api/symptoms/update-popular`

Atualizar estat√≠sticas de sintomas populares (admin apenas).

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

## üí≥ Endpoints de Assinaturas e Pagamentos

### `GET /api/plans`

Listar planos dispon√≠veis.

**Response (200):**
```json
[
  {
    "id": "uuid",
    "name": "Assinatura mensal hotmart",
    "stripePriceId": "price_hotmart_mensal",
    "interval": "MONTH",
    "amount": 3990,
    "currency": "brl",
    "active": true
  },
  {
    "id": "uuid",
    "name": "Assinatura anual hotmart",
    "stripePriceId": "price_hotmart_anual",
    "interval": "YEAR",
    "amount": 35880,
    "currency": "brl",
    "active": true
  }
]
```

**Autentica√ß√£o:** Opcional

---

### `POST /api/stripe/checkout`

Criar sess√£o de checkout do Stripe.

**Request Body:**
```json
{
  "priceId": "price_hotmart_mensal"
}
```

**Response (200):**
```json
{
  "sessionId": "cs_test_abc123",
  "url": "https://checkout.stripe.com/..."
}
```

**Autentica√ß√£o:** Obrigat√≥ria

---

### `GET /api/stripe/subscription`

Obter assinatura ativa do usu√°rio.

**Response (200):**
```json
{
  "id": "uuid",
  "status": "active",
  "plan": {
    "name": "Assinatura mensal hotmart",
    "interval": "MONTH"
  },
  "currentPeriodStart": "2024-01-01T00:00:00.000Z",
  "currentPeriodEnd": "2024-02-01T00:00:00.000Z"
}
```

**Autentica√ß√£o:** Obrigat√≥ria

---

### `POST /api/stripe/subscription/cancel`

Cancelar assinatura ativa.

**Response (200):**
```json
{
  "success": true,
  "subscription": {
    "status": "cancel_at_period_end"
  }
}
```

**Autentica√ß√£o:** Obrigat√≥ria

---

### `GET /api/stripe/invoices`

Listar faturas do usu√°rio.

**Response (200):**
```json
[
  {
    "id": "inv_abc123",
    "amount": 3990,
    "status": "paid",
    "created": 1704067200
  }
]
```

**Autentica√ß√£o:** Obrigat√≥ria

---

### `POST /api/stripe/webhook`

Webhook do Stripe para eventos de pagamento (processado automaticamente).

**Nota:** N√£o deve ser chamado manualmente - Stripe chama automaticamente.

---

### `POST /api/hotmart`

Webhook da Hotmart para eventos de assinatura (processado automaticamente).

**Payload exemplo:**
```json
{
  "event": "PURCHASE_APPROVED",
  "data": {
    "purchase": {
      "transaction": "transaction_id",
      "offer": { "code": "jcuheq2m" },
      "price": { "value": 39.90 },
      "status": "APPROVED"
    },
    "buyer": {
      "email": "comprador@example.com",
      "name": "Nome do Comprador"
    },
    "subscription": {
      "plan": {
        "name": "Plano Mensal",
        "id": "plan_id"
      }
    }
  }
}
```

**Response (200):**
```json
{
  "received": true,
  "success": true,
  "subscriptionId": "uuid"
}
```

**Nota:** N√£o deve ser chamado manualmente - Hotmart chama automaticamente.

**Processamento:**
- Identifica periodicidade (mensal/anual) pelo `subscription.plan.name`
- Busca plano correspondente (`price_hotmart_mensal` ou `price_hotmart_anual`)
- Cria/atualiza assinatura no banco
- Processa cancelamentos via `PURCHASE_CANCELLED` ou `SUBSCRIPTION_CANCELLATION`

---

## üìä Endpoints de Admin

Todos os endpoints de admin exigem autentica√ß√£o com email terminando em `@mediz.com`.

### `GET /api/admin/dashboard-stats`

Estat√≠sticas do dashboard administrativo.

**Response (200):**
```json
{
  "totalUsers": 1000,
  "premiumUsers": 250,
  "freeUsers": 750,
  "activeUsers": 800,
  "totalSubscriptions": 250,
  "activeSubscriptions": 245,
  "totalChatSessions": 5000,
  "pendingAdminRequests": 5,
  "conversionRate": 0.25,
  "recentAuditLogs": [...]
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/users`

Listar usu√°rios com pagina√ß√£o e filtros.

**Query Parameters:**
- `page` (opcional) - P√°gina (padr√£o: 1)
- `limit` (opcional) - Itens por p√°gina (padr√£o: 50)
- `search` (opcional) - Busca por nome/email
- `plan` (opcional) - Filtro: `all`, `free`, `premium`
- `role` (opcional) - Filtro: `all`, `admin`, `user`

**Response (200):**
```json
{
  "users": [
    {
      "id": "uuid",
      "name": "Nome",
      "email": "usuario@example.com",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "subscriptionDetails": {
        "planName": "Assinatura mensal hotmart",
        "planInterval": "MONTH",
        "status": "active",
        "currentPeriodEnd": "2024-02-01T00:00:00.000Z"
      }
    }
  ],
  "pagination": {
    "total": 1000,
    "page": 1,
    "limit": 50,
    "totalPages": 20
  }
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/users/[id]`

Obter detalhes de um usu√°rio espec√≠fico.

**Response (200):**
```json
{
  "id": "uuid",
  "name": "Nome",
  "email": "usuario@example.com",
  "isAdmin": false,
  "plan": "premium",
  "subscriptions": [...],
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `PATCH /api/admin/users/[id]`

Atualizar dados de um usu√°rio (admin).

**Request Body:**
```json
{
  "name": "Novo Nome",
  "email": "novo@example.com",
  "isAdmin": false
}
```

**Response (200):**
```json
{
  "success": true,
  "user": { ... }
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `POST /api/admin/users`

Criar novo usu√°rio (admin).

**Request Body:**
```json
{
  "email": "novo@example.com",
  "password": "senhaSegura123",
  "name": "Nome do Usu√°rio",
  "isAdmin": false
}
```

**Response (201):**
```json
{
  "success": true,
  "userId": "uuid"
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/plans`

Listar planos (apenas os 2 v√°lidos: mensal e anual).

**Response (200):**
```json
[
  {
    "id": "uuid",
    "name": "Assinatura mensal hotmart",
    "stripePriceId": "price_hotmart_mensal",
    "interval": "MONTH",
    "active": true
  },
  {
    "id": "uuid",
    "name": "Assinatura anual hotmart",
    "stripePriceId": "price_hotmart_anual",
    "interval": "YEAR",
    "active": true
  }
]
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/subscriptions`

Listar todas as assinaturas.

**Query Parameters:**
- `status` (opcional) - Filtrar por status
- `page` (opcional) - Pagina√ß√£o

**Response (200):**
```json
[
  {
    "id": "uuid",
    "userId": "uuid",
    "plan": {
      "name": "Assinatura mensal hotmart",
      "interval": "MONTH"
    },
    "status": "active",
    "currentPeriodStart": "2024-01-01T00:00:00.000Z",
    "currentPeriodEnd": "2024-02-01T00:00:00.000Z"
  }
]
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/user-growth`

Estat√≠sticas de crescimento de usu√°rios.

**Query Parameters:**
- `startDate` (opcional) - Data inicial (ISO string)
- `endDate` (opcional) - Data final (ISO string)

**Response (200):**
```json
{
  "total": 1000,
  "growth": [
    {
      "date": "2024-01-01",
      "newUsers": 10,
      "cumulative": 1000
    }
  ]
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/symptoms-metrics`

M√©tricas de sintomas mais pesquisados.

**Response (200):**
```json
{
  "totalSearches": 5000,
  "uniqueSymptoms": 500,
  "topSymptoms": [
    {
      "symptom": "Dor de cabe√ßa",
      "count": 150,
      "percentage": 3.0
    }
  ]
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `POST /api/admin/export`

Exportar dados de usu√°rios em CSV.

**Request Body:**
```json
{
  "format": "csv",
  "filters": {
    "plan": "premium",
    "startDate": "2024-01-01",
    "endDate": "2024-12-31"
  }
}
```

**Response:** Arquivo CSV para download

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `POST /api/admin/export-sintomas`

Exportar sintomas pesquisados em CSV.

**Request Body:**
```json
{
  "startDate": "2024-01-01",
  "endDate": "2024-12-31"
}
```

**Response:** Arquivo CSV para download

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/audit-logs`

Listar logs de auditoria.

**Query Parameters:**
- `action` (opcional) - Filtrar por a√ß√£o
- `userId` (opcional) - Filtrar por usu√°rio
- `page` (opcional) - Pagina√ß√£o

**Response (200):**
```json
[
  {
    "id": "uuid",
    "action": "USER_LOGIN",
    "userId": "uuid",
    "userEmail": "usuario@example.com",
    "metadata": {},
    "ipAddress": "192.168.1.1",
    "timestamp": "2024-01-01T00:00:00.000Z"
  }
]
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `POST /api/admin/audit-logs/login-success`

Registrar login bem-sucedido.

**Request Body:**
```json
{
  "userId": "uuid",
  "email": "usuario@example.com",
  "ipAddress": "192.168.1.1"
}
```

**Response (201):**
```json
{
  "success": true
}
```

**Autentica√ß√£o:** N√£o requerida (chamado internamente)

---

### `POST /api/admin/audit-logs/login-failed`

Registrar tentativa de login falhada.

**Request Body:**
```json
{
  "email": "usuario@example.com",
  "ipAddress": "192.168.1.1",
  "reason": "Invalid credentials"
}
```

**Response (201):**
```json
{
  "success": true
}
```

**Autentica√ß√£o:** N√£o requerida (chamado internamente)

---

### `GET /api/admin/security-alerts`

Listar alertas de seguran√ßa.

**Response (200):**
```json
[
  {
    "id": "uuid",
    "type": "MULTIPLE_FAILED_LOGINS",
    "severity": "high",
    "description": "5 tentativas de login falhadas",
    "ipAddress": "192.168.1.1",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
]
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `POST /api/admin/security-alerts`

Criar alerta de seguran√ßa.

**Request Body:**
```json
{
  "type": "MULTIPLE_FAILED_LOGINS",
  "severity": "high",
  "description": "Descri√ß√£o do alerta",
  "ipAddress": "192.168.1.1"
}
```

**Response (201):**
```json
{
  "success": true,
  "alert": { ... }
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `GET /api/admin/analytics`

Estat√≠sticas avan√ßadas de analytics.

**Response (200):**
```json
{
  "userEngagement": {
    "dailyActiveUsers": 800,
    "weeklyActiveUsers": 2000,
    "monthlyActiveUsers": 5000
  },
  "revenue": {
    "monthly": 50000,
    "annual": 600000
  }
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `POST /api/admin/reset-password`

Resetar senha de um usu√°rio (admin).

**Request Body:**
```json
{
  "userId": "uuid",
  "newPassword": "novaSenhaSegura123"
}
```

**Response (200):**
```json
{
  "success": true
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

## üìÑ Endpoints de PDF

### `POST /api/export-pdf`

Gerar PDF da consulta (premium apenas).

**Request Body:**
```json
{
  "question": "Dor de cabe√ßa frequente",
  "answer": "Resposta em markdown...",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "patientName": "Nome do Paciente",
  "therapistName": "Nome do Terapeuta"
}
```

**Response:** Download do PDF

**Autentica√ß√£o:** Obrigat√≥ria

**Premium:** Funcionalidade dispon√≠vel apenas para usu√°rios premium

---

## üîî Endpoints de Popup

### `GET /api/popup`

Obter configura√ß√£o do popup promocional ativo.

**Response (200):**
```json
{
  "id": "uuid",
  "title": "T√≠tulo do Popup",
  "content": "Conte√∫do em HTML",
  "imageUrl": "https://cloudinary.com/...",
  "status": "ACTIVE",
  "buttonText": "Assinar Agora"
}
```

**Autentica√ß√£o:** Opcional

---

### `POST /api/popup/admin`

Criar/atualizar popup promocional (admin).

**Request Body:**
```json
{
  "title": "T√≠tulo",
  "content": "Conte√∫do HTML",
  "imageUrl": "https://...",
  "status": "ACTIVE",
  "buttonText": "Texto do Bot√£o"
}
```

**Response (200):**
```json
{
  "success": true,
  "popup": { ... }
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

### `POST /api/popup/upload`

Upload de imagem para popup (admin).

**Request:** `multipart/form-data`
- `image`: Arquivo de imagem

**Response (200):**
```json
{
  "success": true,
  "imageUrl": "https://cloudinary.com/..."
}
```

**Autentica√ß√£o:** Obrigat√≥ria (admin)

---

## üîÑ Endpoints de Reset e Verifica√ß√£o

### `POST /api/reset-password`

Solicitar reset de senha via email.

**Request Body:**
```json
{
  "email": "usuario@example.com"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Email de reset enviado"
}
```

---

### `POST /api/verify-signup`

Verificar conta ap√≥s cadastro.

**Request Body:**
```json
{
  "token": "token-de-verificacao"
}
```

**Response (200):**
```json
{
  "success": true
}
```

---

### `POST /api/confirm-signup`

Confirmar cadastro.

**Request Body:**
```json
{
  "token": "token-de-confirmacao"
}
```

**Response (200):**
```json
{
  "success": true
}
```

---

## üìà Endpoints de Analytics

### `POST /api/analytics`

Registrar evento de analytics.

**Request Body:**
```json
{
  "event": "page_view",
  "properties": {
    "page": "/chat"
  }
}
```

**Response (200):**
```json
{
  "success": true
}
```

**Autentica√ß√£o:** Opcional

---

## üß™ Endpoints de Debug

### `GET /api/auth-debug`

Endpoint de debug para verificar estado de autentica√ß√£o (desenvolvimento apenas).

**Response (200):**
```json
{
  "session": { ... },
  "isAuthenticated": true,
  "isAdmin": false
}
```

---

## üîß Configura√ß√µes e Vari√°veis de Ambiente

### Vari√°veis Necess√°rias

```env
# Database
DATABASE_URL="postgresql://user:password@host:5432/database"

# NextAuth
NEXTAUTH_SECRET="secret-key-aqui"
NEXTAUTH_URL="https://mediz.app" # ou http://localhost:3000 em dev

# Google OAuth
GOOGLE_CLIENT_ID="seu-client-id"
GOOGLE_CLIENT_SECRET="seu-client-secret"

# OpenAI
OPENAI_API_KEY="sk-..."
OPENAI_ASSISTANT_ID="asst_..."

# Stripe
STRIPE_SECRET_KEY="sk_..."
STRIPE_PUBLISHABLE_KEY="pk_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# Hotmart
HOTMART_MEDIZ_PRODUCT_ID="product-id"
HOTMART_MONTHLY_PRICE_CODE="price_hotmart_mensal"
HOTMART_YEARLY_PRICE_CODE="price_hotmart_anual"

# Cloudinary
CLOUDINARY_CLOUD_NAME="cloud-name"
CLOUDINARY_API_KEY="api-key"
CLOUDINARY_API_SECRET="api-secret"
```

---

## üìä Modelos do Banco de Dados

### Principais Modelos (Prisma)

#### User
```prisma
model User {
  id            String        @id @default(uuid())
  name          String?
  email         String        @unique
  passwordHash  String?
  fullName      String?
  whatsapp      String?
  age           Int?
  gender        Gender?
  profession    String?
  appUsage      AppUsage?
  createdAt     DateTime      @default(now())
  subscriptions Subscription[]
  chatSessions  ChatSession[]
  symptomFolders SymptomFolder[]
}
```

#### Subscription
```prisma
model Subscription {
  id                  String   @id @default(uuid())
  userId              String
  planId              String
  stripeSubscriptionId String?  @unique
  status              String
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  user                User     @relation(...)
  plan                Plan     @relation(...)
}
```

#### Plan
```prisma
model Plan {
  id            String         @id @default(uuid())
  name          String
  stripePriceId String         @unique
  interval      PlanInterval?
  amount        Int?
  currency      String?
  active        Boolean        @default(true)
  subscriptions Subscription[]
}
```

#### ChatSession
```prisma
model ChatSession {
  id        String   @id @default(uuid())
  userId    String
  threadId  String?  @unique
  favorite  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(...)
}
```

#### SymptomFolder
```prisma
model SymptomFolder {
  id        String        @id @default(uuid())
  userId    String
  name      String
  color     String?
  notes     String?
  createdAt DateTime      @default(now())
  symptoms  SavedSymptom[]
}
```

#### SavedSymptom
```prisma
model SavedSymptom {
  id        String        @id @default(uuid())
  folderId  String
  symptom   String
  threadId  String?
  createdAt DateTime      @default(now())
  folder    SymptomFolder @relation(...)
}
```

---

## üîí Seguran√ßa

### Autentica√ß√£o
- Senhas hashadas com **bcryptjs** (10 rounds)
- Tokens JWT com expira√ß√£o de 365 dias
- Cookies HTTP-only para sess√µes
- CSRF protection via NextAuth

### Autoriza√ß√£o
- Rotas admin verificam email `@mediz.com`
- Verifica√ß√£o de propriedade de recursos (usu√°rio s√≥ acessa seus pr√≥prios dados)
- Valida√ß√£o de assinaturas premium para funcionalidades espec√≠ficas

### Valida√ß√£o
- Valida√ß√£o de entrada em todos os endpoints
- Sanitiza√ß√£o de dados antes de salvar no banco
- Rate limiting via verifica√ß√£o de limites di√°rios

### Logs e Auditoria
- Sistema de auditoria completo (`AuditLog`)
- Logs de tentativas de login falhadas
- Alertas de seguran√ßa para padr√µes suspeitos

---

## üöÄ Performance

### Otimiza√ß√µes Implementadas

1. **Cache Global de Usu√°rio** - Cache em mem√≥ria para dados da sidebar
2. **Queries Otimizadas** - Busca apenas campos necess√°rios
3. **Lazy Loading** - Carregamento sob demanda de componentes
4. **Image Optimization** - Cloudinary para otimiza√ß√£o autom√°tica de imagens
5. **Database Indexing** - √çndices em campos frequentemente consultados

---

## üìù Notas de Desenvolvimento

### Conven√ß√µes

- **Nomenclatura:** camelCase para vari√°veis, PascalCase para componentes
- **Imports:** Sempre usar caminhos absolutos com `@/`
- **TypeScript:** Strict mode desabilitado, mas tipagem recomendada
- **Error Handling:** Sempre retornar `NextResponse.json()` com status apropriado

### Testes

O projeto inclui v√°rios scripts de teste em `src/scripts/`:
- `test-api-response.ts` - Testar respostas da API
- `test-subscriptions.ts` - Validar assinaturas
- `test-user-periods.ts` - Testar per√≠odos de usu√°rio

---

## üîó Refer√™ncias

- [Next.js 15 Documentation](https://nextjs.org/docs)
- [NextAuth v5 Documentation](https://authjs.dev)
- [Prisma Documentation](https://www.prisma.io/docs)
- [OpenAI Assistants API](https://platform.openai.com/docs/assistants)
- [Stripe API](https://stripe.com/docs/api)

---

**√öltima atualiza√ß√£o:** Janeiro 2025  
**Vers√£o da API:** 1.0.0

