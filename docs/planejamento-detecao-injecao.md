# üõ°Ô∏è Planejamento: Detec√ß√£o de SQL/Command Injection - meDIZ

**Data:** Janeiro 2025  
**Status:** üìã **Em Planejamento**  
**Vers√£o:** 1.0

---

## üìã Sum√°rio Executivo

Este documento apresenta o planejamento completo para implementar um sistema de detec√ß√£o autom√°tica de tentativas de **SQL Injection** e **Command Injection** na plataforma meDIZ, com alertas autom√°ticos enviados aos administradores via WhatsApp e registros no painel admin.

### Objetivo Principal
‚úÖ **Detectar em tempo real** tentativas de inje√ß√£o de comandos (SQL, Command) em requisi√ß√µes HTTP e **alertar automaticamente** os administradores quando dados maliciosos s√£o enviados ao servidor.

---

## üéØ O que s√£o SQL Injection e Command Injection?

### SQL Injection (SQLi)
- **Defini√ß√£o:** Tentativa de injetar c√≥digo SQL malicioso atrav√©s de entrada de dados do usu√°rio
- **Exemplo:** `' OR '1'='1` ou `'; DROP TABLE users; --`
- **Impacto:** Acesso n√£o autorizado ao banco de dados, roubo de dados, exclus√£o de dados

### Command Injection
- **Defini√ß√£o:** Tentativa de executar comandos do sistema operacional atrav√©s de entrada do usu√°rio
- **Exemplo:** `; rm -rf /` ou `| cat /etc/passwd`
- **Impacto:** Execu√ß√£o de comandos arbitr√°rios no servidor, acesso ao sistema de arquivos

---

## üîç Situa√ß√£o Atual

### Prote√ß√µes Existentes
‚úÖ **Prisma ORM** - Usa prepared statements (prote√ß√£o autom√°tica contra SQLi)
‚úÖ **Valida√ß√£o de Dados** - React Hook Form + Zod
‚úÖ **Sanitiza√ß√£o** - Dados sanitizados antes de salvar

### Vulnerabilidades Potenciais
‚ö†Ô∏è **Inputs n√£o validados** podem chegar at√© queries do Prisma
‚ö†Ô∏è **APIs que recebem dados do usu√°rio** podem ser alvo
‚ö†Ô∏è **Sem detec√ß√£o proativa** de tentativas de ataque
‚ö†Ô∏è **Sem alertas autom√°ticos** quando tentativas s√£o detectadas

### Oportunidades
‚úÖ Sistema de alertas j√° existe (`/api/admin/security-alerts`)
‚úÖ WhatsApp j√° configurado para envio de alertas
‚úÖ Painel admin j√° tem p√°gina de alertas (`/admin/security-alerts`)
‚úÖ Sistema de audit logs j√° implementado

---

## üèóÔ∏è Arquitetura Proposta

### 1. **Camada de Detec√ß√£o**
```
Requisi√ß√£o HTTP
    ‚Üì
Middleware Next.js (detec√ß√£o)
    ‚Üì
Biblioteca de Detec√ß√£o (sql-injection-detector.ts)
    ‚Üì
An√°lise de padr√µes maliciosos
    ‚Üì
Retorno: { detected: true, type: 'SQL_INJECTION', patterns: [...] }
```

### 2. **Camada de Resposta**
```
Detec√ß√£o Positiva
    ‚Üì
Bloquear requisi√ß√£o (403 Forbidden)
    ‚Üì
Registrar no audit log
    ‚Üì
Disparar alerta autom√°tico via WhatsApp
    ‚Üì
Registrar no banco de dados
```

### 3. **Camada de Visualiza√ß√£o**
```
Painel Admin
    ‚Üì
P√°gina de Alertas de Inje√ß√£o
    ‚Üì
Lista de tentativas detectadas
    ‚Üì
Filtros e estat√≠sticas
```

---

## üìä Padr√µes de Detec√ß√£o

### SQL Injection Patterns

```typescript
const SQL_INJECTION_PATTERNS = [
  // Comment injection
  /(--|\#|\/\*|\*\/)/i,
  // Union-based
  /union[\s]+select/i,
  // Boolean-based
  /('|"|;|`)[\s]*(or|and)[\s]+[\d\w]+[\s]*=[\s]*[\d\w]+/i,
  /('|"|;|`)[\s]*(or|and)[\s]+[\d\w]+[\s]*like[\s]+[\d\w]+/i,
  // Time-based
  /(sleep|waitfor|delay)[\s]*\(/i,
  // Function-based
  /(version|database|user|concat|cast|convert|exec|execute|sp_executesql)\(/i,
  // Stacked queries
  /;[\s]*(drop|delete|truncate|update|insert|alter|create)/i,
  // Error-based
  /(extractvalue|updatexml|exp|floor|rand)\(/i,
]
```

### Command Injection Patterns

```typescript
const COMMAND_INJECTION_PATTERNS = [
  // Command chaining
  /[;&|`$(){}[\]]+/,
  // System commands
  /(rm|del|mv|cp|cat|ls|dir|ps|kill|chmod|chown|sudo|su|sh|bash|cmd|powershell)/i,
  // Path traversal
  /\.\.(\/|\\)/,
  // Redirection
  /[<>][\s]*[\w\.\/]+/,
  // Environment variables
  /\$\{?[\w]+\}?/,
  // Windows commands
  /(ipconfig|netstat|tasklist|systeminfo)/i,
]
```

---

## üîß Implementa√ß√£o T√©cnica

### Fase 1: Biblioteca de Detec√ß√£o

**Arquivo:** `src/lib/security/injection-detector.ts`

**Responsabilidades:**
- Detectar padr√µes de SQL Injection
- Detectar padr√µes de Command Injection
- Retornar detalhes sobre a detec√ß√£o (tipo, padr√£o encontrado, localiza√ß√£o)

**Interface:**
```typescript
interface InjectionDetectionResult {
  detected: boolean
  type?: 'SQL_INJECTION' | 'COMMAND_INJECTION'
  pattern?: string
  location?: 'query' | 'body' | 'headers'
  severity: 'low' | 'medium' | 'high' | 'critical'
  details: {
    field?: string
    value?: string
    matchedPattern?: string
  }
}
```

### Fase 2: Integra√ß√£o no Middleware

**Arquivo:** `src/middleware.ts` (modificar)

**Funcionalidades:**
- Executar detec√ß√£o em todas as requisi√ß√µes API (`/api/*`)
- Analisar query parameters, body, headers
- Bloquear requisi√ß√µes maliciosas (403)
- Disparar alertas autom√°ticos

### Fase 3: Sistema de Alertas Autom√°ticos

**Arquivo:** `src/lib/security/alert-service.ts`

**Responsabilidades:**
- Receber detec√ß√µes do middleware
- Enviar alertas via WhatsApp usando sistema existente
- Registrar no audit log
- Salvar no banco de dados (nova tabela `injection_attempts`)

### Fase 4: API de Visualiza√ß√£o

**Arquivo:** `src/app/api/admin/injection-attempts/route.ts`

**Responsabilidades:**
- Listar tentativas de inje√ß√£o
- Filtros (tipo, data, IP)
- Estat√≠sticas
- Exporta√ß√£o de dados

### Fase 5: Interface no Painel Admin

**Arquivo:** `src/app/admin/injection-attempts/page.tsx`

**Funcionalidades:**
- Lista de tentativas detectadas
- Filtros avan√ßados
- Gr√°ficos e estat√≠sticas
- Detalhes de cada tentativa
- A√ß√µes (bloquear IP, etc.)

---

## üìù Schema do Banco de Dados

### Tabela: `injection_attempts`

```prisma
model InjectionAttempt {
  id            String   @id @default(uuid())
  type          String   // 'SQL_INJECTION' | 'COMMAND_INJECTION'
  severity      String   // 'low' | 'medium' | 'high' | 'critical'
  pattern       String   // Padr√£o detectado
  location      String   // 'query' | 'body' | 'headers'
  field         String?  // Campo onde foi detectado (opcional)
  value         String?  // Valor suspeito (sanitizado)
  endpoint      String   // Endpoint atacado
  method        String   // HTTP method
  ipAddress     String   // IP do atacante
  userAgent     String?  // User agent
  userId        String?  // ID do usu√°rio (se autenticado)
  blocked       Boolean  @default(true) // Se foi bloqueado
  alertSent     Boolean  @default(false) // Se alerta foi enviado
  createdAt     DateTime @default(now())
  
  @@index([type])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([blocked])
}
```

---

## üîÑ Fluxo de Detec√ß√£o

### Fluxo Completo

```
1. Requisi√ß√£o HTTP chega ao servidor
   ‚Üì
2. Middleware intercepta (todas as /api/*)
   ‚Üì
3. Extrai dados: query params, body, headers
   ‚Üì
4. Executa detec√ß√£o usando injection-detector
   ‚Üì
5. Se detectado:
   a. Bloqueia requisi√ß√£o (403)
   b. Registra no banco (injection_attempts)
   c. Registra no audit log
   d. Dispara alerta via WhatsApp
   ‚Üì
6. Se n√£o detectado:
   ‚Üí Continua processamento normal
```

### Exemplo de Requisi√ß√£o Maliciosa

```
POST /api/user/form
Body: {
  "fullName": "'; DROP TABLE users; --",
  "age": 30
}
```

**Detec√ß√£o:**
- ‚úÖ Detecta padr√£o SQL: `'; DROP TABLE users; --`
- ‚úÖ Tipo: `SQL_INJECTION`
- ‚úÖ Severidade: `critical`
- ‚úÖ Bloqueia requisi√ß√£o
- ‚úÖ Envia alerta aos admins

---

## üö® Sistema de Alertas

### Tipos de Alerta

1. **SQL_INJECTION_DETECTED**
   - Quando padr√£o SQL √© detectado
   - Severidade: Alta/Cr√≠tica
   - Enviar imediatamente

2. **COMMAND_INJECTION_DETECTED**
   - Quando padr√£o de comando √© detectado
   - Severidade: Cr√≠tica
   - Enviar imediatamente

### Formato do Alerta WhatsApp

```
üö® ALERTA DE SEGURAN√áA - meDIZ

Tipo: SQL Injection Detectado
Severidade: CR√çTICA

Detalhes:
‚Ä¢ Endpoint: /api/user/form
‚Ä¢ IP: 192.168.1.100
‚Ä¢ Padr√£o: '; DROP TABLE users; --
‚Ä¢ Campo: fullName
‚Ä¢ Bloqueado: Sim

Data: 2025-01-XX 14:30:00
```

---

## üìä M√©tricas e Monitoramento

### KPIs a Acompanhar
- üìà **N√∫mero de tentativas por dia**
- üìà **Tipos de inje√ß√£o mais comuns**
- üìà **IPs mais ativos**
- üìà **Endpoints mais atacados**
- üìà **Taxa de bloqueio**

### Dashboard Recomendado
- Gr√°fico de tentativas ao longo do tempo
- Top 10 IPs maliciosos
- Top 10 endpoints atacados
- Distribui√ß√£o por tipo (SQL vs Command)
- Distribui√ß√£o por severidade

---

## ‚ö†Ô∏è Considera√ß√µes Importantes

### Performance
- ‚úÖ Detec√ß√£o √© r√°pida (regex matching)
- ‚úÖ Executada apenas em rotas `/api/*`
- ‚ö†Ô∏è Evitar falsos positivos com padr√µes muito agressivos

### Falsos Positivos
- ‚ö†Ô∏è Alguns padr√µes podem detectar dados leg√≠timos
- ‚úÖ Permitir whitelist de padr√µes conhecidos
- ‚úÖ Permitir desabilitar detec√ß√£o para endpoints espec√≠ficos

### Privacidade
- ‚úÖ N√£o armazenar dados sens√≠veis completos
- ‚úÖ Sanitizar valores antes de salvar
- ‚úÖ Limitar tempo de reten√ß√£o (30 dias)

### Escalabilidade
- ‚úÖ √çndices no banco para queries r√°pidas
- ‚úÖ Limitar n√∫mero de tentativas por IP (rate limiting)
- ‚úÖ Cache de IPs bloqueados

---

## üîí Seguran√ßa Adicional

### Bloqueio de IP
- Ap√≥s X tentativas do mesmo IP, bloquear temporariamente
- Lista de IPs bloqueados
- Desbloqueio manual ou autom√°tico ap√≥s 24h

### Rate Limiting
- Limitar requisi√ß√µes por IP em um per√≠odo
- Prevenir ataques de for√ßa bruta

### Logging Detalhado
- Registrar todas as tentativas
- Manter hist√≥rico para an√°lise forense
- Exporta√ß√£o de logs para an√°lise externa

---

## üìÖ Cronograma de Implementa√ß√£o

### Fase 1: Biblioteca de Detec√ß√£o (2-3 dias)
- [ ] Criar `injection-detector.ts`
- [ ] Implementar padr√µes SQL Injection
- [ ] Implementar padr√µes Command Injection
- [ ] Testes unit√°rios

### Fase 2: Integra√ß√£o no Middleware (2 dias)
- [ ] Modificar `middleware.ts`
- [ ] Adicionar detec√ß√£o em todas as rotas `/api/*`
- [ ] Implementar bloqueio de requisi√ß√µes
- [ ] Testes de integra√ß√£o

### Fase 3: Sistema de Alertas (2 dias)
- [ ] Criar `alert-service.ts`
- [ ] Integrar com sistema WhatsApp existente
- [ ] Criar schema Prisma para `injection_attempts`
- [ ] Migration do banco de dados

### Fase 4: API de Visualiza√ß√£o (1-2 dias)
- [ ] Criar `/api/admin/injection-attempts`
- [ ] Implementar filtros e pagina√ß√£o
- [ ] Estat√≠sticas e agrega√ß√µes

### Fase 5: Interface Admin (2-3 dias)
- [ ] Criar p√°gina `/admin/injection-attempts`
- [ ] Tabela de tentativas
- [ ] Filtros e busca
- [ ] Gr√°ficos e estat√≠sticas

### Fase 6: Testes e Valida√ß√£o (2 dias)
- [ ] Testes com payloads reais
- [ ] Valida√ß√£o de falsos positivos
- [ ] Ajustes de padr√µes
- [ ] Documenta√ß√£o

**Total Estimado:** 11-14 dias

---

## üéØ Pr√≥ximos Passos Imediatos

1. ‚úÖ Criar biblioteca de detec√ß√£o
2. ‚úÖ Criar schema Prisma
3. ‚úÖ Modificar middleware
4. ‚úÖ Criar servi√ßo de alertas
5. ‚úÖ Testar com payloads reais

---

## üìö Refer√™ncias

- **OWASP SQL Injection:** https://owasp.org/www-community/attacks/SQL_Injection
- **OWASP Command Injection:** https://owasp.org/www-community/attacks/Command_Injection
- **Prisma Security:** https://www.prisma.io/docs/guides/performance-and-optimization/connection-management
- **Next.js Middleware:** https://nextjs.org/docs/app/building-your-application/routing/middleware

---

**Documento criado por:** AI Assistant (modo planejador)  
**√öltima atualiza√ß√£o:** Janeiro 2025  
**Status:** ‚úÖ Pronto para implementa√ß√£o

