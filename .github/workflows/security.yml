name: Security & Dependencies Check

on:
  schedule:
    # Executa toda segunda-feira √†s 9h UTC
    - cron: '0 9 * * 1'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-audit:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîí Audit dependencies
        run: npm audit --audit-level=moderate

      - name: üîç Check for known vulnerabilities
        run: |
          echo "üîç Checking for security vulnerabilities..."
          npm audit --json > audit-results.json || true
          
          # Verifica se h√° vulnerabilidades cr√≠ticas ou altas
          HIGH_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "üìä Vulnerability Summary:"
          echo "  - Critical: $CRITICAL_VULNS"
          echo "  - High: $HIGH_VULNS"
          
          if [ "$CRITICAL_VULNS" -gt 0 ] || [ "$HIGH_VULNS" -gt 0 ]; then
            echo "‚ùå Found critical or high severity vulnerabilities!"
            exit 1
          else
            echo "‚úÖ No critical or high severity vulnerabilities found"
          fi

      - name: üìã Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: audit-results.json
          retention-days: 30

  dependency-check:
    name: üì¶ Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Check for outdated packages
        run: |
          echo "üîç Checking for outdated packages..."
          npm outdated --json > outdated-packages.json || true
          
          # Conta quantos pacotes est√£o desatualizados
          OUTDATED_COUNT=$(cat outdated-packages.json | jq 'length')
          
          echo "üìä Outdated packages: $OUTDATED_COUNT"
          
          if [ "$OUTDATED_COUNT" -gt 10 ]; then
            echo "‚ö†Ô∏è  Many packages are outdated. Consider updating."
          else
            echo "‚úÖ Package versions are up to date"
          fi

      - name: üìã Upload outdated packages report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-packages-report
          path: outdated-packages.json
          retention-days: 7

  license-check:
    name: üìÑ License Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üìÑ Check package licenses
        run: |
          echo "üìÑ Checking package licenses..."
          npx license-checker --json > license-report.json || true
          
          # Verifica licen√ßas problem√°ticas
          PROBLEMATIC_LICENSES=$(cat license-report.json | jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|Copyleft")) | .key' | wc -l)
          
          echo "üìä License Summary:"
          echo "  - Packages with problematic licenses: $PROBLEMATIC_LICENSES"
          
          if [ "$PROBLEMATIC_LICENSES" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found packages with GPL/AGPL licenses!"
            echo "Consider replacing these packages with MIT/Apache alternatives"
          else
            echo "‚úÖ All packages have compatible licenses"
          fi

      - name: üìã Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  code-quality:
    name: üéØ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üéØ Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: üîç Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: üßπ ESLint with security rules
        run: |
          echo "üßπ Running ESLint with security rules..."
          npx eslint src --ext .ts,.tsx --format json > eslint-security-report.json || true
          
          # Verifica se h√° problemas de seguran√ßa
          SECURITY_ISSUES=$(cat eslint-security-report.json | jq '[.[] | select(.messages[] | .ruleId | test("security"))] | length')
          
          echo "üìä Security Issues Found: $SECURITY_ISSUES"
          
          if [ "$SECURITY_ISSUES" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found potential security issues in code!"
          else
            echo "‚úÖ No security issues found in code"
          fi

      - name: üìã Upload ESLint security report
        uses: actions/upload-artifact@v4
        with:
          name: eslint-security-report
          path: eslint-security-report.json
          retention-days: 30
